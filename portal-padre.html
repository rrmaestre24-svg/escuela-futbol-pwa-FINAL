<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0d9488">
    <meta name="description" content="Portal de Padres - Consulta el perfil de tu hijo">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>Portal de Padres - MY CLUB</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    
    <!-- Manifest para PWA -->
    <link rel="manifest" href="parent-manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</text></svg>">
    
    <style>
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-float { animation: float 3s ease-in-out infinite; }
        
        @keyframes slide-up {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up { animation: slide-up 0.3s ease-out; }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin { animation: spin 1s linear infinite; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse { animation: pulse 2s ease-in-out infinite; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen transition-colors duration-300">
    
    <!-- Contenedor de Login -->
    <div id="loginContainer" class="min-h-screen flex flex-col items-center justify-center p-4">
        <!-- Logo animado -->
        <div class="text-6xl mb-6 animate-float">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</div>
        
        <h1 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">Portal de Padres</h1>
        <p class="text-gray-500 dark:text-gray-400 mb-8 text-center">Accede al perfil de tu hijo</p>
        
        <!-- Formulario de Login -->
        <form id="parentLoginForm" class="w-full max-w-sm space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    ğŸ« Club ID
                </label>
                <input 
                    type="text" 
                    id="parentClubId" 
                    required
                    placeholder="ej: mi_club_futbol"
                    class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-teal-500 dark:bg-gray-800 dark:text-white text-lg"
                >
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    ğŸ” CÃ³digo de Acceso
                </label>
                <input 
                    type="text" 
                    id="parentAccessCode" 
                    required
                    placeholder="ej: ABC123"
                    maxlength="6"
                    class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-teal-500 dark:bg-gray-800 dark:text-white text-lg uppercase tracking-widest text-center font-mono"
                >
            </div>
            
            <button 
                type="submit" 
                class="w-full bg-gradient-to-r from-teal-600 to-blue-600 hover:from-teal-700 hover:to-blue-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg transition-all transform hover:scale-[1.02]"
            >
                Acceder al Perfil
            </button>
        </form>
        
        <!-- Info -->
        <div class="mt-8 text-center text-sm text-gray-500 dark:text-gray-400">
            <p>Â¿No tienes cÃ³digo?</p>
            <p>SolicÃ­talo al administrador de la escuela</p>
        </div>
        
        <!-- Toggle Dark Mode -->
        <button onclick="toggleDarkModeParent()" class="mt-6 p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
            <span class="dark:hidden">ğŸŒ™</span>
            <span class="hidden dark:inline">â˜€ï¸</span>
        </button>
    </div>
    
    <!-- Contenedor del Perfil (oculto inicialmente) -->
    <div id="profileContainer" class="hidden">
        <!-- El contenido se genera dinÃ¡micamente en JS -->
    </div>
    
    <!-- Modal de Sugerencias -->
    <div id="suggestionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <!-- Header -->
            <div class="bg-gradient-to-r from-amber-500 to-orange-500 p-4 rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-white flex items-center gap-2">
                        ğŸ’¡ Mejoras de la App
                    </h3>
                    <button onclick="closeSuggestionModal()" class="text-white hover:bg-white/20 rounded-lg p-1">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="flex border-b border-gray-200 dark:border-gray-700">
                <button onclick="showSuggestionTab('new')" id="tabNew" class="flex-1 py-3 text-sm font-medium text-amber-600 border-b-2 border-amber-500">
                    âœï¸ Nueva
                </button>
                <button onclick="showSuggestionTab('history')" id="tabHistory" class="flex-1 py-3 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700">
                    ğŸ“‹ Mis Sugerencias
                </button>
            </div>
            
            <!-- Tab: Nueva Sugerencia -->
            <div id="newSuggestionTab" class="p-4">
                <!-- Nota informativa -->
                <div class="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-lg p-3 mb-4">
                    <p class="text-sm text-blue-700 dark:text-blue-300">
                        ğŸ“± <strong>Â¿Tienes ideas para mejorar esta app?</strong><br>
                        Tu mensaje serÃ¡ enviado al <strong>desarrollador de MY CLUB</strong>, no a la escuela de tu hijo.
                    </p>
                </div>
                
                <form id="suggestionForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tu Nombre</label>
                        <input type="text" id="suggestionName" required placeholder="Ej: MarÃ­a GarcÃ­a"
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tipo de mensaje</label>
                        <select id="suggestionType" required
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                            <option value="">Seleccionar...</option>
                            <option value="sugerencia">ğŸ’¡ Sugerencia de mejora</option>
                            <option value="bug">ğŸ› Reportar un error</option>
                            <option value="pregunta">â“ Pregunta sobre la app</option>
                            <option value="felicitacion">ğŸ‰ FelicitaciÃ³n</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tu mensaje</label>
                        <textarea id="suggestionMessage" required rows="4" placeholder="Ej: Me gustarÃ­a que la app tuviera... / EncontrÃ© un error cuando..."
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white resize-none"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">TelÃ©fono (opcional)</label>
                        <input type="tel" id="suggestionPhone" placeholder="Ej: +57 300 123 4567"
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                    </div>
                    
                    <button type="submit" class="w-full bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2">
                        ğŸ“¤ Enviar al Desarrollador
                    </button>
                </form>
            </div>
            
            <!-- Tab: Historial de Sugerencias -->
            <div id="historySuggestionTab" class="hidden p-4">
                <div id="suggestionsList" class="space-y-4">
                    <!-- Se llena dinÃ¡micamente -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de EdiciÃ³n de Perfil -->
    <div id="editProfileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto animate-slide-up">
            <div class="bg-gradient-to-r from-teal-600 to-blue-600 p-4 rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-white">âœï¸ Editar Perfil</h3>
                    <button onclick="closeEditProfileModal()" class="text-white hover:bg-white/20 rounded-lg p-1">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <form id="editProfileForm" class="p-4 space-y-4">
                <div class="text-center">
                    <div class="relative inline-block">
                        <img id="editAvatarPreview" src="" alt="Foto" class="w-24 h-24 rounded-full object-cover border-4 border-teal-500 mx-auto">
                        <!-- BotÃ³n de cÃ¡mara mejorado para mÃ³viles -->
                        <button type="button" onclick="document.getElementById('editAvatarInput').click()" class="absolute bottom-0 right-0 bg-teal-500 text-white p-2 rounded-full shadow-lg hover:bg-teal-600 active:bg-teal-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </button>
                    </div>
                    <!-- Input de archivo - SIN capture para dar opciÃ³n de cÃ¡mara o galerÃ­a -->
                    <input type="file" id="editAvatarInput" accept="image/*" class="hidden" onchange="previewEditAvatar(event)">
                    <!-- BotÃ³n alternativo grande para mÃ³viles -->
                    <button type="button" onclick="document.getElementById('editAvatarInput').click()" class="mt-3 w-full py-2 px-4 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg text-sm font-medium hover:bg-gray-200 dark:hover:bg-gray-600 active:bg-gray-300">
                        ğŸ“· Cambiar foto
                    </button>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ğŸ‘¤ Nombre</label>
                    <input type="text" id="editName" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ğŸ‚ Fecha de nacimiento</label>
                    <input type="date" id="editBirthDate" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ğŸ”¢ Dorsal</label>
                    <input type="number" id="editJerseyNumber" min="1" max="99" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ğŸ“ TelÃ©fono</label>
                    <input type="tel" id="editPhone" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ğŸ  DirecciÃ³n</label>
                    <input type="text" id="editAddress" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ğŸš¨ Contacto emergencia</label>
                    <input type="tel" id="editEmergencyContact" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                </div>
                <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                    <h4 class="font-bold text-gray-800 dark:text-white mb-3">ğŸ¥ Info MÃ©dica</h4>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ğŸ©¸ Tipo de sangre</label>
                    <select id="editBloodType" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                        <option value="">Seleccionar...</option>
                        <option value="A+">A+</option><option value="A-">A-</option>
                        <option value="B+">B+</option><option value="B-">B-</option>
                        <option value="AB+">AB+</option><option value="AB-">AB-</option>
                        <option value="O+">O+</option><option value="O-">O-</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">âš ï¸ Alergias</label>
                    <textarea id="editAllergies" rows="2" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white resize-none"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ğŸ“‹ Condiciones mÃ©dicas</label>
                    <textarea id="editConditions" rows="2" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white resize-none"></textarea>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeEditProfileModal()" class="flex-1 py-3 border border-gray-300 dark:border-gray-600 rounded-xl text-gray-700 dark:text-gray-300 font-medium hover:bg-gray-100 dark:hover:bg-gray-700">Cancelar</button>
                    <button type="submit" id="saveProfileBtn" class="flex-1 py-3 bg-gradient-to-r from-teal-600 to-blue-600 text-white rounded-xl font-bold">ğŸ’¾ Guardar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Toast -->
    <div id="parentToast" class="hidden fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-slide-up"></div>
    
    <!-- SCRIPT INLINE - Todo el cÃ³digo del portal -->
    <script>
// ========================================
// PORTAL DE PADRES - LÃ“GICA COMPLETA
// ========================================

// Estado del portal
let currentPlayer = null;
let currentClubId = null;
let currentClubSettings = null;
let mySuggestions = [];

// ========================================
// INICIALIZACIÃ“N
// ========================================

document.addEventListener('DOMContentLoaded', function() {
  console.log('ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Portal de Padres iniciando...');
  checkSavedSession();
  const loginForm = document.getElementById('parentLoginForm');
  if (loginForm) {
    loginForm.addEventListener('submit', handleParentLogin);
  }
  
  const suggestionForm = document.getElementById('suggestionForm');
  if (suggestionForm) {
    suggestionForm.addEventListener('submit', handleSuggestionSubmit);
  }
  
  applyDarkModeParent();
});

// ========================================
// AUTENTICACIÃ“N
// ========================================

async function handleParentLogin(e) {
  e.preventDefault();
  
  const clubId = document.getElementById('parentClubId').value.trim().toLowerCase();
  const accessCode = document.getElementById('parentAccessCode').value.trim().toUpperCase();
  
  if (!clubId || !accessCode) {
    showParentToast('âŒ Completa todos los campos');
    return;
  }
  
  const submitBtn = e.target.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerHTML;
  submitBtn.innerHTML = '<span class="animate-spin">â³</span> Verificando...';
  submitBtn.disabled = true;
  
  try {
    const success = await loadClubDataFromFirebase(clubId, accessCode);
    
    if (success) {
      saveParentSession(clubId, accessCode);
      showPlayerProfile();
      showParentToast('âœ… Â¡Bienvenido!');
    } else {
      showParentToast('âŒ CÃ³digo o Club ID invÃ¡lido');
    }
  } catch (error) {
    console.error('Error en login de padre:', error);
    showParentToast('âŒ Error al verificar. Intenta de nuevo.');
  } finally {
    submitBtn.innerHTML = originalText;
    submitBtn.disabled = false;
  }
}

async function loadClubDataFromFirebase(clubId, accessCode) {
  try {
    if (!window.firebase?.db) {
      await initFirebaseForParent();
    }
    
    if (!window.firebase?.db) {
      console.error('Firebase no disponible');
      return false;
    }
    
    const codesRef = window.firebase.collection(window.firebase.db, `clubs/${clubId}/parentCodes`);
    const codesSnapshot = await window.firebase.getDocs(codesRef);
    
    let playerId = null;
    
    codesSnapshot.forEach(doc => {
      const data = doc.data();
      if (data.code === accessCode) {
        playerId = data.playerId;
      }
    });
    
    if (!playerId) {
      console.log('CÃ³digo no encontrado');
      return false;
    }
    
    const playerRef = window.firebase.doc(window.firebase.db, `clubs/${clubId}/players`, playerId);
    const playerSnap = await window.firebase.getDoc(playerRef);
    
    if (!playerSnap.exists()) {
      console.log('Jugador no encontrado');
      return false;
    }
    
    currentPlayer = { id: playerSnap.id, ...playerSnap.data() };
    
    const settingsRef = window.firebase.doc(window.firebase.db, `clubs/${clubId}/settings`, 'main');
    const settingsSnap = await window.firebase.getDoc(settingsRef);
    
    if (settingsSnap.exists()) {
      currentClubSettings = settingsSnap.data();
    } else {
      currentClubSettings = { name: 'Escuela de FÃºtbol' };
    }
    
    const paymentsRef = window.firebase.collection(window.firebase.db, `clubs/${clubId}/payments`);
    const paymentsSnapshot = await window.firebase.getDocs(paymentsRef);
    
    const playerPayments = [];
    paymentsSnapshot.forEach(doc => {
      const payment = { id: doc.id, ...doc.data() };
      if (payment.playerId === playerId) {
        playerPayments.push(payment);
      }
    });
    
    currentPlayer.payments = playerPayments;
    
    // Cargar prÃ³ximos eventos del club
    try {
      const eventsRef = window.firebase.collection(window.firebase.db, `clubs/${clubId}/events`);
      const eventsSnapshot = await window.firebase.getDocs(eventsRef);
      
      const today = new Date().toISOString().split('T')[0];
      const upcomingEvents = [];
      
      eventsSnapshot.forEach(doc => {
        const event = { id: doc.id, ...doc.data() };
        if (event.date >= today) {
          upcomingEvents.push(event);
        }
      });
      
      currentPlayer.upcomingEvents = upcomingEvents
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .slice(0, 5);
    } catch (e) {
      console.log('No se pudieron cargar eventos');
      currentPlayer.upcomingEvents = [];
    }
    
    currentClubId = clubId;
    
    // Cargar sugerencias del padre
    await loadMySuggestions();
    
    console.log('âœ… Datos cargados correctamente');
    return true;
    
  } catch (error) {
    console.error('Error al cargar datos:', error);
    return false;
  }
}

async function initFirebaseForParent() {
  try {
    const firebaseConfig = {
      apiKey: "AIzaSyBThVgzEsTLWSW7puKOVErZ_KOLDEq8v3A",
      authDomain: "my-club-fae98.firebaseapp.com",
      projectId: "my-club-fae98",
      storageBucket: "my-club-fae98.firebasestorage.app",
      messagingSenderId: "807792685568",
      appId: "1:807792685568:web:06097faad391a9fd8c9ee5"
    };
    
    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
    const { getFirestore, collection, doc, getDoc, getDocs, addDoc, updateDoc, query, where, orderBy, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    window.firebase = { db, collection, doc, getDoc, getDocs, addDoc, updateDoc, query, where, orderBy, serverTimestamp };
    
    console.log('âœ… Firebase inicializado para portal de padres');
    return true;
  } catch (error) {
    console.error('Error al inicializar Firebase:', error);
    return false;
  }
}

// ========================================
// SESIÃ“N
// ========================================

function saveParentSession(clubId, accessCode) {
  localStorage.setItem('parentSession', JSON.stringify({ clubId, accessCode, savedAt: new Date().toISOString() }));
}

function getParentSession() {
  try {
    const session = localStorage.getItem('parentSession');
    return session ? JSON.parse(session) : null;
  } catch { return null; }
}

function clearParentSession() {
  localStorage.removeItem('parentSession');
  currentPlayer = null;
  currentClubId = null;
  currentClubSettings = null;
}

async function checkSavedSession() {
  const session = getParentSession();
  
  if (session && session.clubId && session.accessCode) {
    document.getElementById('loginContainer').innerHTML = `
      <div class="text-center py-8">
        <div class="animate-spin text-4xl mb-4">âš½</div>
        <p class="text-gray-600 dark:text-gray-400">Cargando...</p>
      </div>
    `;
    
    const success = await loadClubDataFromFirebase(session.clubId, session.accessCode);
    
    if (success) {
      showPlayerProfile();
    } else {
      clearParentSession();
      location.reload();
    }
  }
}

// ========================================
// RENDERIZADO DEL PERFIL
// ========================================

// FunciÃ³n auxiliar para generar HTML de prÃ³ximo pago
function getNextPaymentHTML(payments) {
  const pendingPayments = payments.filter(p => p.status === 'Pendiente' && p.dueDate);
  if (pendingPayments.length === 0) return '';
  
  const nextPayment = pendingPayments.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))[0];
  const dueDate = new Date(nextPayment.dueDate);
  const today = new Date();
  today.setHours(0,0,0,0);
  dueDate.setHours(0,0,0,0);
  const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
  
  let urgencyColor, urgencyBg, urgencyText, urgencyIcon;
  if (diffDays < 0) {
    urgencyColor = 'from-red-600 to-red-700';
    urgencyBg = 'bg-red-100 dark:bg-red-900/50';
    urgencyText = 'âš ï¸ VENCIDO hace ' + Math.abs(diffDays) + ' dÃ­a(s)';
    urgencyIcon = 'ğŸš¨';
  } else if (diffDays === 0) {
    urgencyColor = 'from-red-500 to-orange-500';
    urgencyBg = 'bg-red-100 dark:bg-red-900/50';
    urgencyText = 'Â¡VENCE HOY!';
    urgencyIcon = 'â°';
  } else if (diffDays <= 3) {
    urgencyColor = 'from-orange-500 to-yellow-500';
    urgencyBg = 'bg-orange-100 dark:bg-orange-900/50';
    urgencyText = 'Vence en ' + diffDays + ' dÃ­a(s)';
    urgencyIcon = 'âš¡';
  } else if (diffDays <= 7) {
    urgencyColor = 'from-yellow-500 to-amber-500';
    urgencyBg = 'bg-yellow-100 dark:bg-yellow-900/50';
    urgencyText = 'Vence en ' + diffDays + ' dÃ­as';
    urgencyIcon = 'ğŸ“…';
  } else {
    urgencyColor = 'from-blue-500 to-teal-500';
    urgencyBg = 'bg-blue-100 dark:bg-blue-900/50';
    urgencyText = 'Vence en ' + diffDays + ' dÃ­as';
    urgencyIcon = 'âœ…';
  }
  
  const progressWidth = Math.max(0, Math.min(100, (30 - diffDays) / 30 * 100));
  const progressColor = diffDays < 0 ? 'bg-red-500' : diffDays <= 3 ? 'bg-orange-500' : diffDays <= 7 ? 'bg-yellow-500' : 'bg-green-500';
  const dueDateFormatted = new Date(nextPayment.dueDate).toLocaleDateString('es-CO', { weekday: 'long', day: 'numeric', month: 'long' });
  
  let whatsappBtn = '';
  if (currentClubSettings?.phone) {
    const msg = encodeURIComponent('Hola, soy el acudiente de ' + currentPlayer.name + '. Quisiera informaciÃ³n sobre el pago de: ' + (nextPayment.concept || nextPayment.type));
    whatsappBtn = '<a href="https://wa.me/' + currentClubSettings.phone.replace(/[^0-9+]/g, '') + '?text=' + msg + '" target="_blank" class="mt-4 w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2">ğŸ“± Contactar para pagar</a>';
  }
  
  return '<div class="rounded-2xl overflow-hidden shadow-lg">' +
    '<div class="bg-gradient-to-r ' + urgencyColor + ' p-4 text-white">' +
      '<div class="flex items-center justify-between">' +
        '<div class="flex items-center gap-2"><span class="text-2xl">' + urgencyIcon + '</span><span class="font-bold">PrÃ³ximo Pago</span></div>' +
        '<span class="text-sm font-medium px-3 py-1 bg-white/20 rounded-full">' + urgencyText + '</span>' +
      '</div>' +
    '</div>' +
    '<div class="' + urgencyBg + ' p-4">' +
      '<div class="flex items-center justify-between mb-3">' +
        '<div><p class="font-bold text-gray-800 dark:text-white text-lg">' + (nextPayment.concept || nextPayment.type) + '</p>' +
        '<p class="text-sm text-gray-600 dark:text-gray-400">Fecha lÃ­mite: ' + dueDateFormatted + '</p></div>' +
        '<div class="text-right"><p class="text-2xl font-bold text-gray-800 dark:text-white">' + formatCurrencyParent(nextPayment.amount) + '</p></div>' +
      '</div>' +
      '<div class="mt-3">' +
        '<div class="flex justify-between text-xs text-gray-600 dark:text-gray-400 mb-1"><span>Tiempo restante</span><span>' + (diffDays > 0 ? diffDays + ' dÃ­as' : (diffDays === 0 ? 'Hoy' : 'Vencido')) + '</span></div>' +
        '<div class="w-full bg-gray-300 dark:bg-gray-600 rounded-full h-2"><div class="h-2 rounded-full ' + progressColor + '" style="width: ' + progressWidth + '%"></div></div>' +
      '</div>' +
      whatsappBtn +
    '</div>' +
  '</div>';
}

// FunciÃ³n auxiliar para generar HTML de eventos
function getEventsHTML(events) {
  if (!events || events.length === 0) {
    return '<div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden">' +
      '<div class="bg-gradient-to-r from-blue-500 to-purple-500 px-4 py-3"><h3 class="font-bold text-white">ğŸ“… PrÃ³ximos Eventos</h3></div>' +
      '<div class="p-4 text-center py-8"><span class="text-4xl">ğŸ“­</span><p class="text-gray-500 dark:text-gray-400 mt-2">No hay eventos prÃ³ximos</p></div>' +
    '</div>';
  }
  
  let eventsItems = '';
  events.forEach(function(event) {
    const eventDate = new Date(event.date);
    const today = new Date();
    today.setHours(0,0,0,0);
    eventDate.setHours(0,0,0,0);
    const diffDays = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));
    
    const eventColors = {
      'Partido': 'from-blue-500 to-blue-600',
      'Entrenamiento': 'from-green-500 to-green-600',
      'Torneo': 'from-yellow-500 to-orange-500',
      'ReuniÃ³n': 'from-purple-500 to-purple-600'
    };
    const bgColor = eventColors[event.type] || 'from-gray-500 to-gray-600';
    
    let daysText = '';
    if (diffDays === 0) daysText = 'ğŸ”´ HOY';
    else if (diffDays === 1) daysText = 'ğŸŸ¡ MaÃ±ana';
    else if (diffDays <= 7) daysText = 'ğŸŸ¢ En ' + diffDays + ' dÃ­as';
    else daysText = 'En ' + diffDays + ' dÃ­as';
    
    const dateFormatted = eventDate.toLocaleDateString('es-CO', { weekday: 'long', day: 'numeric', month: 'long' });
    
    eventsItems += '<div class="border border-gray-200 dark:border-gray-700 rounded-xl overflow-hidden">' +
      '<div class="bg-gradient-to-r ' + bgColor + ' p-3 flex items-center justify-between">' +
        '<div class="flex items-center gap-2"><span class="text-2xl">' + getEventIcon(event.type) + '</span><span class="text-white font-medium">' + (event.type || 'Evento') + '</span></div>' +
        '<span class="text-white text-sm font-bold">' + daysText + '</span>' +
      '</div>' +
      '<div class="p-3 bg-gray-50 dark:bg-gray-700">' +
        '<p class="font-bold text-gray-800 dark:text-white">' + event.title + '</p>' +
        '<div class="flex flex-wrap gap-3 mt-2 text-sm text-gray-600 dark:text-gray-400">' +
          '<span>ğŸ“† ' + dateFormatted + '</span>' +
          (event.time ? '<span>ğŸ• ' + event.time + '</span>' : '') +
        '</div>' +
        (event.location ? '<p class="mt-2 text-sm text-gray-600 dark:text-gray-400">ğŸ“ ' + event.location + '</p>' : '') +
      '</div>' +
    '</div>';
  });
  
  return '<div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden">' +
    '<div class="bg-gradient-to-r from-blue-500 to-purple-500 px-4 py-3"><h3 class="font-bold text-white">ğŸ“… PrÃ³ximos Eventos</h3></div>' +
    '<div class="p-4 space-y-3">' + eventsItems + '</div>' +
  '</div>';
}

// FunciÃ³n auxiliar para generar HTML de pagos con botÃ³n de recibo
function getPaymentsHTML(payments) {
  if (payments.length === 0) {
    return '<p class="text-center text-gray-500 dark:text-gray-400 py-8">No hay pagos registrados</p>';
  }
  
  let html = '';
  const sortedPayments = payments.sort((a, b) => new Date(b.dueDate || b.createdAt) - new Date(a.dueDate || a.createdAt));
  
  sortedPayments.forEach(function(payment, index) {
    const statusClass = payment.status === 'Pagado' ? 'bg-green-50 dark:bg-green-900/20' : 'bg-red-50 dark:bg-red-900/20';
    const statusTextClass = payment.status === 'Pagado' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
    const statusIcon = payment.status === 'Pagado' ? 'âœ… Pagado' : 'â³ Pendiente';
    
    let receiptBtn = '';
    if (payment.status === 'Pagado') {
      receiptBtn = '<button onclick="downloadPaymentReceipt(' + index + ')" class="mt-2 w-full bg-white dark:bg-gray-800 border border-green-300 dark:border-green-700 text-green-600 dark:text-green-400 py-2 rounded-lg text-sm font-medium flex items-center justify-center gap-2 hover:bg-green-100 dark:hover:bg-green-900/50">ğŸ“„ Descargar Recibo</button>';
    }
    
    html += '<div class="border border-gray-200 dark:border-gray-700 rounded-xl overflow-hidden ' + statusClass + '">' +
      '<div class="p-3">' +
        '<div class="flex items-center justify-between">' +
          '<div><p class="font-medium text-gray-800 dark:text-white">' + (payment.concept || payment.type) + '</p>' +
          '<p class="text-xs text-gray-500 dark:text-gray-400">' + formatDateParent(payment.paidDate || payment.dueDate) + '</p></div>' +
          '<div class="text-right"><p class="font-bold text-gray-800 dark:text-white">' + formatCurrencyParent(payment.amount) + '</p>' +
          '<span class="text-xs font-medium ' + statusTextClass + '">' + statusIcon + '</span></div>' +
        '</div>' +
        receiptBtn +
      '</div>' +
    '</div>';
  });
  
  return html;
}

function showPlayerProfile() {
  if (!currentPlayer) {
    showParentToast('âŒ Error al cargar perfil');
    return;
  }
  
  document.getElementById('loginContainer').classList.add('hidden');
  const profileContainer = document.getElementById('profileContainer');
  profileContainer.classList.remove('hidden');
  
  const age = calculateAge(currentPlayer.birthDate);
  const payments = currentPlayer.payments || [];
  const totalPaid = payments.filter(p => p.status === 'Pagado').reduce((sum, p) => sum + (p.amount || 0), 0);
  const totalPending = payments.filter(p => p.status === 'Pendiente').reduce((sum, p) => sum + (p.amount || 0), 0);
  const unreadResponses = mySuggestions.filter(s => s.response && !s.responseRead).length;
  
  // Generar HTML de pagos, prÃ³ximo pago y eventos usando funciones auxiliares
  const paymentsHTML = getPaymentsHTML(payments);
  const nextPaymentHTML = getNextPaymentHTML(payments);
  const eventsHTML = getEventsHTML(currentPlayer.upcomingEvents);
  
  // Status del pago
  let paymentStatusHTML = '';
  if (totalPending > 0 && !nextPaymentHTML) {
    paymentStatusHTML = '<div class="bg-orange-50 dark:bg-orange-900/30 rounded-2xl p-4 text-center border-2 border-orange-200 dark:border-orange-800"><span class="text-2xl">âš ï¸</span><p class="text-orange-700 dark:text-orange-300 font-medium mt-2">Tienes pagos pendientes</p><p class="text-sm text-orange-600 dark:text-orange-400">Contacta a la escuela para mÃ¡s informaciÃ³n</p></div>';
  } else if (totalPending === 0) {
    paymentStatusHTML = '<div class="bg-green-100 dark:bg-green-900/30 rounded-2xl p-4 text-center"><span class="text-2xl">ğŸ‰</span><p class="text-green-700 dark:text-green-300 font-medium mt-2">Â¡Todo al dÃ­a!</p><p class="text-sm text-green-600 dark:text-green-400">No tienes pagos pendientes</p></div>';
  }

  profileContainer.innerHTML = `
    <div class="bg-gradient-to-r from-teal-600 to-blue-600 text-white p-4 flex items-center gap-3">
      <img src="${currentClubSettings?.logo || getDefaultLogoParent()}" alt="Logo" class="w-12 h-12 rounded-lg object-cover">
      <div class="flex-1">
        <h1 class="font-bold text-lg">${currentClubSettings?.name || 'Escuela de FÃºtbol'}</h1>
        <p class="text-sm opacity-90">Portal de Padres</p>
      </div>
      <button onclick="openSuggestionModal()" class="p-2 hover:bg-white/20 rounded-lg transition-colors relative" title="Sugerencias">
        <span class="text-xl">ğŸ’¡</span>
        ${unreadResponses > 0 ? `<span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center animate-pulse">${unreadResponses}</span>` : ''}
      </button>
      <button onclick="parentLogout()" class="p-2 hover:bg-white/20 rounded-lg transition-colors" title="Cerrar sesiÃ³n">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
        </svg>
      </button>
    </div>
    
    <div class="p-4 space-y-4">
      <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg text-center">
        <img src="${currentPlayer.avatar || getDefaultAvatarParent()}" alt="${currentPlayer.name}" 
             class="w-32 h-32 rounded-full object-cover border-4 border-teal-500 mx-auto mb-4 shadow-lg">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white">${currentPlayer.name}</h2>
        <p class="text-gray-500 dark:text-gray-400">${currentPlayer.category} â€¢ ${age} aÃ±os</p>
        ${currentPlayer.position ? `<p class="text-teal-600 dark:text-teal-400 font-medium mt-1">${currentPlayer.position} ${currentPlayer.jerseyNumber ? 'â€¢ Dorsal #' + currentPlayer.jerseyNumber : ''}</p>` : ''}
        <span class="inline-block mt-2 px-4 py-1 rounded-full text-sm font-medium ${currentPlayer.status === 'Activo' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300'}">
          ${currentPlayer.status || 'Activo'}
        </span>
        
        <button onclick="openEditProfileModal()" class="mt-4 w-full bg-gradient-to-r from-teal-500 to-blue-500 hover:from-teal-600 hover:to-blue-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg">
          âœï¸ Editar Datos del Jugador
        </button>
      </div>
      
      <div class="grid grid-cols-2 gap-4">
        <div class="bg-green-50 dark:bg-green-900/30 rounded-xl p-4 text-center">
          <p class="text-xs text-green-600 dark:text-green-400 mb-1">Total Pagado</p>
          <p class="text-xl font-bold text-green-700 dark:text-green-300">${formatCurrencyParent(totalPaid)}</p>
        </div>
        <div class="bg-red-50 dark:bg-red-900/30 rounded-xl p-4 text-center">
          <p class="text-xs text-red-600 dark:text-red-400 mb-1">Pendiente</p>
          <p class="text-xl font-bold text-red-700 dark:text-red-300">${formatCurrencyParent(totalPending)}</p>
        </div>
      </div>
      
      ${nextPaymentHTML || paymentStatusHTML}
      
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden">
        <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 border-b border-gray-200 dark:border-gray-600">
          <h3 class="font-bold text-gray-800 dark:text-white">ğŸ’° Historial de Pagos</h3>
        </div>
        <div class="p-4">
          <div class="space-y-3 max-h-64 overflow-y-auto">${paymentsHTML}</div>
        </div>
      </div>
      
      ${currentPlayer.medicalInfo?.bloodType || currentPlayer.medicalInfo?.allergies ? `
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-lg">
          <h3 class="font-bold text-gray-800 dark:text-white mb-3 flex items-center gap-2">
            ğŸ¥ InformaciÃ³n MÃ©dica
          </h3>
          <div class="space-y-2 text-sm">
            ${currentPlayer.medicalInfo?.bloodType ? `
              <div class="flex justify-between">
                <span class="text-gray-500 dark:text-gray-400">Tipo de sangre:</span>
                <span class="font-medium text-gray-800 dark:text-white">${currentPlayer.medicalInfo.bloodType}</span>
              </div>
            ` : ''}
            ${currentPlayer.medicalInfo?.allergies ? `
              <div class="flex justify-between">
                <span class="text-gray-500 dark:text-gray-400">Alergias:</span>
                <span class="font-medium text-red-600 dark:text-red-400">${currentPlayer.medicalInfo.allergies}</span>
              </div>
            ` : ''}
            ${currentPlayer.medicalInfo?.conditions ? `
              <div class="flex justify-between">
                <span class="text-gray-500 dark:text-gray-400">Condiciones:</span>
                <span class="font-medium text-gray-800 dark:text-white">${currentPlayer.medicalInfo.conditions}</span>
              </div>
            ` : ''}
          </div>
        </div>
      ` : ''}
      
      ${currentClubSettings?.phone ? `
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-lg">
          <h3 class="font-bold text-gray-800 dark:text-white mb-3">ğŸ“ Contacto del Club</h3>
          <a href="https://wa.me/${currentClubSettings.phone.replace(/[^0-9+]/g, '')}" target="_blank"
             class="flex items-center gap-3 p-3 bg-green-50 dark:bg-green-900/30 rounded-xl hover:bg-green-100 transition-colors">
            <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white">ğŸ“±</div>
            <div>
              <p class="font-medium text-gray-800 dark:text-white">WhatsApp</p>
              <p class="text-sm text-gray-500 dark:text-gray-400">${currentClubSettings.phone}</p>
            </div>
          </a>
        </div>
      ` : ''}
      
      ${eventsHTML}
      
      <button onclick="openSuggestionModal()" class="w-full bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white py-4 rounded-2xl font-bold text-lg shadow-lg flex items-center justify-center gap-3 transition-all transform hover:scale-[1.02] relative">
        <span class="text-2xl">ğŸ’¡</span>
        Sugerir Mejoras de la App
        ${unreadResponses > 0 ? `<span class="bg-white text-amber-600 text-sm rounded-full px-2 py-0.5">${unreadResponses} respuesta(s)</span>` : ''}
      </button>
      
      <div id="installPrompt" class="hidden bg-gradient-to-r from-purple-500 to-blue-500 rounded-2xl p-4 text-white">
        <div class="flex items-center gap-3">
          <div class="text-3xl">ğŸ“²</div>
          <div class="flex-1">
            <p class="font-bold">Instala la App</p>
            <p class="text-sm opacity-90">Accede mÃ¡s rÃ¡pido</p>
          </div>
          <button onclick="installParentPWA()" class="bg-white text-purple-600 px-4 py-2 rounded-lg font-medium">Instalar</button>
        </div>
      </div>
      
      <button onclick="generatePlayerCard()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white py-4 rounded-2xl font-bold text-lg shadow-lg flex items-center justify-center gap-3 transition-all transform hover:scale-[1.02]">
        <span class="text-2xl">ğŸªª</span>
        Descargar Carnet del Jugador
      </button>
    </div>
  `;
  
  checkInstallPrompt();
}

// ========================================
// SISTEMA DE SUGERENCIAS
// ========================================

function openSuggestionModal() {
  document.getElementById('suggestionModal').classList.remove('hidden');
  showSuggestionTab('new');
}

function closeSuggestionModal() {
  document.getElementById('suggestionModal').classList.add('hidden');
}

function showSuggestionTab(tab) {
  const tabNew = document.getElementById('tabNew');
  const tabHistory = document.getElementById('tabHistory');
  const newTab = document.getElementById('newSuggestionTab');
  const historyTab = document.getElementById('historySuggestionTab');
  
  if (tab === 'new') {
    tabNew.classList.add('text-amber-600', 'border-b-2', 'border-amber-500');
    tabNew.classList.remove('text-gray-500');
    tabHistory.classList.remove('text-amber-600', 'border-b-2', 'border-amber-500');
    tabHistory.classList.add('text-gray-500');
    newTab.classList.remove('hidden');
    historyTab.classList.add('hidden');
  } else {
    tabHistory.classList.add('text-amber-600', 'border-b-2', 'border-amber-500');
    tabHistory.classList.remove('text-gray-500');
    tabNew.classList.remove('text-amber-600', 'border-b-2', 'border-amber-500');
    tabNew.classList.add('text-gray-500');
    historyTab.classList.remove('hidden');
    newTab.classList.add('hidden');
    renderSuggestionHistory();
  }
}

async function loadMySuggestions() {
  try {
    if (!window.firebase?.db || !currentPlayer?.id) return;
    
    const suggestionsRef = window.firebase.collection(window.firebase.db, 'suggestions');
    const q = window.firebase.query(
      suggestionsRef,
      window.firebase.where('playerId', '==', currentPlayer.id),
      window.firebase.where('clubId', '==', currentClubId)
    );
    
    const snapshot = await window.firebase.getDocs(q);
    mySuggestions = [];
    
    snapshot.forEach(doc => {
      mySuggestions.push({ id: doc.id, ...doc.data() });
    });
    
    // Ordenar por fecha
    mySuggestions.sort((a, b) => {
      const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt);
      const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt);
      return dateB - dateA;
    });
    
    console.log('âœ… Sugerencias cargadas:', mySuggestions.length);
  } catch (error) {
    console.error('Error al cargar sugerencias:', error);
  }
}

function renderSuggestionHistory() {
  const container = document.getElementById('suggestionsList');
  
  if (mySuggestions.length === 0) {
    container.innerHTML = `
      <div class="text-center py-8 text-gray-500 dark:text-gray-400">
        <span class="text-4xl">ğŸ“­</span>
        <p class="mt-2">No has enviado sugerencias aÃºn</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = mySuggestions.map(s => {
    const date = s.createdAt?.toDate ? s.createdAt.toDate() : new Date(s.createdAt);
    const typeIcons = {
      'sugerencia': 'ğŸ’¡',
      'pregunta': 'â“',
      'queja': 'ğŸ˜¤',
      'felicitacion': 'ğŸ‰'
    };
    
    return `
      <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4 ${s.response && !s.responseRead ? 'border-2 border-amber-500' : ''}">
        <div class="flex items-start justify-between mb-2">
          <span class="text-2xl">${typeIcons[s.type] || 'ğŸ’¬'}</span>
          <span class="text-xs text-gray-500 dark:text-gray-400">${date.toLocaleDateString('es-CO')}</span>
        </div>
        <p class="text-gray-800 dark:text-white mb-2">${s.message}</p>
        
        ${s.response ? `
          <div class="mt-3 p-3 bg-teal-50 dark:bg-teal-900/30 rounded-lg border-l-4 border-teal-500">
            <p class="text-xs text-teal-600 dark:text-teal-400 font-medium mb-1">âœ… Respuesta del administrador:</p>
            <p class="text-gray-700 dark:text-gray-300">${s.response}</p>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${s.responseAt ? new Date(s.responseAt.toDate ? s.responseAt.toDate() : s.responseAt).toLocaleDateString('es-CO') : ''}</p>
          </div>
          ${!s.responseRead ? `
            <button onclick="markAsRead('${s.id}')" class="mt-2 text-sm text-teal-600 dark:text-teal-400 underline">Marcar como leÃ­da</button>
          ` : ''}
        ` : `
          <div class="mt-2 flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400">
            <span class="animate-pulse">â³</span> Pendiente de respuesta
          </div>
        `}
      </div>
    `;
  }).join('');
}

async function handleSuggestionSubmit(e) {
  e.preventDefault();
  
  const name = document.getElementById('suggestionName').value.trim();
  const type = document.getElementById('suggestionType').value;
  const message = document.getElementById('suggestionMessage').value.trim();
  const phone = document.getElementById('suggestionPhone').value.trim();
  
  if (!name || !type || !message) {
    showParentToast('âŒ Completa todos los campos requeridos');
    return;
  }
  
  const submitBtn = e.target.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  submitBtn.innerHTML = 'â³ Enviando...';
  
  try {
    const suggestionData = {
      // InformaciÃ³n del remitente
      senderName: name,
      senderPhone: phone || null,
      senderType: 'parent', // parent, admin
      
      // InformaciÃ³n del contexto
      clubId: currentClubId,
      clubName: currentClubSettings?.name || 'Sin nombre',
      playerId: currentPlayer.id,
      playerName: currentPlayer.name,
      
      // Contenido
      type: type,
      message: message,
      
      // Estado
      status: 'pending', // pending, responded
      response: null,
      responseAt: null,
      responseRead: false,
      
      // Fechas
      createdAt: window.firebase.serverTimestamp()
    };
    
    await window.firebase.addDoc(
      window.firebase.collection(window.firebase.db, 'suggestions'),
      suggestionData
    );
    
    showParentToast('âœ… Sugerencia enviada correctamente');
    
    // Limpiar formulario
    document.getElementById('suggestionForm').reset();
    
    // Recargar sugerencias
    await loadMySuggestions();
    
    // Mostrar historial
    showSuggestionTab('history');
    
  } catch (error) {
    console.error('Error al enviar sugerencia:', error);
    showParentToast('âŒ Error al enviar. Intenta de nuevo.');
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerHTML = 'ğŸ“¤ Enviar al Desarrollador';
  }
}

async function markAsRead(suggestionId) {
  try {
    const { updateDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
    const suggestionRef = window.firebase.doc(window.firebase.db, 'suggestions', suggestionId);
    await updateDoc(suggestionRef, { responseRead: true });
    
    // Actualizar localmente
    const suggestion = mySuggestions.find(s => s.id === suggestionId);
    if (suggestion) suggestion.responseRead = true;
    
    renderSuggestionHistory();
    showPlayerProfile(); // Actualizar contador
    showParentToast('âœ… Marcada como leÃ­da');
  } catch (error) {
    console.error('Error:', error);
  }
}

// ========================================
// LOGOUT Y UTILIDADES
// ========================================

function parentLogout() {
  if (confirm('Â¿Cerrar sesiÃ³n?')) {
    clearParentSession();
    location.reload();
  }
}

function calculateAge(birthDate) {
  if (!birthDate) return '-';
  const today = new Date();
  const birth = new Date(birthDate);
  let age = today.getFullYear() - birth.getFullYear();
  const monthDiff = today.getMonth() - birth.getMonth();
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) age--;
  return age;
}

function formatCurrencyParent(amount) {
  return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(amount || 0);
}

function formatDateParent(dateStr) {
  if (!dateStr) return '-';
  return new Date(dateStr).toLocaleDateString('es-CO', { day: 'numeric', month: 'short', year: 'numeric' });
}

function getDefaultLogoParent() {
  return 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Ccircle cx="50" cy="50" r="45" fill="%230d9488"/%3E%3Ctext x="50" y="65" font-size="50" text-anchor="middle" fill="white"%3Eâš½%3C/text%3E%3C/svg%3E';
}

function getDefaultAvatarParent() {
  return 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Ccircle cx="50" cy="50" r="45" fill="%236b7280"/%3E%3Ctext x="50" y="65" font-size="50" text-anchor="middle" fill="white"%3EğŸ‘¤%3C/text%3E%3C/svg%3E';
}

function getEventIcon(type) {
  const icons = {
    'Entrenamiento': 'âš½',
    'Partido': 'ğŸ†',
    'Torneo': 'ğŸ–ï¸',
    'ReuniÃ³n': 'ğŸ‘¥',
    'Festivo': 'ğŸ‰',
    'Otro': 'ğŸ“Œ'
  };
  return icons[type] || 'ğŸ“…';
}

function showParentToast(message) {
  const toast = document.getElementById('parentToast');
  if (toast) {
    toast.textContent = message;
    toast.classList.remove('hidden');
    setTimeout(() => toast.classList.add('hidden'), 3000);
  }
}

function applyDarkModeParent() {
  if (localStorage.getItem('parentDarkMode') === 'true') {
    document.documentElement.classList.add('dark');
  }
}

function toggleDarkModeParent() {
  const isDark = document.documentElement.classList.toggle('dark');
  localStorage.setItem('parentDarkMode', isDark.toString());
}

// ========================================
// PWA INSTALL
// ========================================

let deferredPrompt = null;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  checkInstallPrompt();
});

function checkInstallPrompt() {
  const installDiv = document.getElementById('installPrompt');
  if (installDiv && deferredPrompt) installDiv.classList.remove('hidden');
}

async function installParentPWA() {
  if (!deferredPrompt) {
    showParentToast('La app ya estÃ¡ instalada');
    return;
  }
  
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  
  if (outcome === 'accepted') showParentToast('âœ… Â¡App instalada!');
  
  deferredPrompt = null;
  document.getElementById('installPrompt')?.classList.add('hidden');
}

// ========================================
// GENERAR CARNET PDF MEJORADO
// ========================================

async function generatePlayerCard() {
  if (!currentPlayer) {
    showParentToast('âŒ No hay datos del jugador');
    return;
  }
  
  showParentToast('â³ Generando carnet...');
  
  try {
    if (typeof window.jspdf === 'undefined') {
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
    }
    
    const jsPDF = window.jspdf.jsPDF;
    // TamaÃ±o mÃ¡s grande: 100x65mm (formato tarjeta de crÃ©dito)
    const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: [100, 65] });
    
    const width = 100;
    const height = 65;
    const currentYear = new Date().getFullYear();
    const age = calculateAge(currentPlayer.birthDate);
    const playerId = (currentPlayer.id || 'unknown').substring(0, 8).toUpperCase();
    
    // ========== LADO FRONTAL ==========
    
    // Header con gradiente (teal)
    doc.setFillColor(13, 148, 136);
    doc.rect(0, 0, width, 20, 'F');
    
    // Franja mÃ¡s oscura debajo
    doc.setFillColor(10, 120, 110);
    doc.rect(0, 18, width, 3, 'F');
    
    // Fondo blanco para contenido
    doc.setFillColor(255, 255, 255);
    doc.rect(0, 21, width, height - 21, 'F');
    
    // Logo del club
    if (currentClubSettings?.logo && currentClubSettings.logo.startsWith('data:image')) {
      try { 
        doc.addImage(currentClubSettings.logo, 'PNG', 4, 3, 14, 14); 
      } catch (e) {}
    }
    
    // Nombre del club
    doc.setFontSize(11);
    doc.setTextColor(255, 255, 255);
    doc.setFont('helvetica', 'bold');
    doc.text((currentClubSettings?.name || 'Escuela de FÃºtbol').substring(0, 30), 21, 9);
    
    // SubtÃ­tulo
    doc.setFontSize(6);
    doc.setFont('helvetica', 'normal');
    doc.text('CARNET OFICIAL DE JUGADOR ' + currentYear, 21, 15);
    
    // Marco de foto con bordes redondeados
    doc.setDrawColor(13, 148, 136);
    doc.setLineWidth(0.8);
    doc.roundedRect(5, 25, 25, 32, 2, 2, 'S');
    
    // Foto del jugador
    if (currentPlayer.avatar && currentPlayer.avatar.startsWith('data:image')) {
      try { 
        doc.addImage(currentPlayer.avatar, 'JPEG', 6, 26, 23, 30); 
      } catch (e) {}
    }
    
    // InformaciÃ³n del jugador
    let infoX = 34;
    let infoY = 27;
    
    // Nombre
    doc.setFontSize(10);
    doc.setTextColor(30, 30, 30);
    doc.setFont('helvetica', 'bold');
    doc.text((currentPlayer.name || 'Sin nombre').substring(0, 25), infoX, infoY);
    
    // LÃ­nea decorativa debajo del nombre
    doc.setDrawColor(13, 148, 136);
    doc.setLineWidth(0.5);
    doc.line(infoX, infoY + 1, infoX + 40, infoY + 1);
    
    infoY += 6;
    doc.setFontSize(7);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(80, 80, 80);
    
    // CategorÃ­a
    doc.setFont('helvetica', 'bold');
    doc.text('CategorÃ­a:', infoX, infoY);
    doc.setFont('helvetica', 'normal');
    doc.text(currentPlayer.category || '-', infoX + 18, infoY);
    
    infoY += 5;
    // PosiciÃ³n
    doc.setFont('helvetica', 'bold');
    doc.text('PosiciÃ³n:', infoX, infoY);
    doc.setFont('helvetica', 'normal');
    doc.text(currentPlayer.position || '-', infoX + 18, infoY);
    
    infoY += 5;
    // Fecha de nacimiento con edad
    doc.setFont('helvetica', 'bold');
    doc.text('Nacimiento:', infoX, infoY);
    doc.setFont('helvetica', 'normal');
    var birthText = currentPlayer.birthDate ? formatDateParent(currentPlayer.birthDate) + ' (' + age + ' aÃ±os)' : '-';
    doc.text(birthText, infoX + 18, infoY);
    
    infoY += 5;
    // Documento
    if (currentPlayer.documentNumber) {
      doc.setFont('helvetica', 'bold');
      doc.text('Documento:', infoX, infoY);
      doc.setFont('helvetica', 'normal');
      doc.text(currentPlayer.documentNumber, infoX + 18, infoY);
      infoY += 5;
    }
    
    // TelÃ©fono
    if (currentPlayer.phone) {
      doc.setFont('helvetica', 'bold');
      doc.text('TelÃ©fono:', infoX, infoY);
      doc.setFont('helvetica', 'normal');
      doc.text(currentPlayer.phone, infoX + 18, infoY);
    }
    
    // Dorsal grande en esquina
    if (currentPlayer.jerseyNumber) {
      doc.setFillColor(13, 148, 136);
      doc.roundedRect(width - 20, height - 18, 17, 15, 2, 2, 'F');
      doc.setFontSize(16);
      doc.setTextColor(255, 255, 255);
      doc.setFont('helvetica', 'bold');
      doc.text('#' + currentPlayer.jerseyNumber, width - 11.5, height - 7, { align: 'center' });
    }
    
    // Footer con vigencia
    doc.setFillColor(245, 245, 245);
    doc.rect(0, height - 5, width, 5, 'F');
    doc.setFontSize(5);
    doc.setTextColor(100, 100, 100);
    doc.text('Vigencia: ' + currentYear + ' | ID: ' + playerId, 5, height - 1.5);
    
    // ========== LADO REVERSO ==========
    doc.addPage([100, 65], 'landscape');
    
    // Fondo gris claro
    doc.setFillColor(250, 250, 250);
    doc.rect(0, 0, width, height, 'F');
    
    // Header
    doc.setFillColor(13, 148, 136);
    doc.rect(0, 0, width, 12, 'F');
    
    doc.setFontSize(8);
    doc.setTextColor(255, 255, 255);
    doc.setFont('helvetica', 'bold');
    doc.text('INFORMACIÃ“N MÃ‰DICA Y DE EMERGENCIA', width / 2, 8, { align: 'center' });
    
    let medY = 18;
    doc.setFontSize(7);
    doc.setTextColor(60, 60, 60);
    
    // Tipo de sangre (destacado)
    doc.setFillColor(255, 230, 230);
    doc.roundedRect(5, medY - 3, 40, 10, 1, 1, 'F');
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(180, 0, 0);
    doc.text('TIPO DE SANGRE:', 7, medY + 2);
    doc.setFontSize(9);
    doc.text(currentPlayer.medicalInfo?.bloodType || 'N/E', 35, medY + 2);
    
    medY += 12;
    doc.setFontSize(6);
    doc.setTextColor(60, 60, 60);
    
    // Alergias
    doc.setFont('helvetica', 'bold');
    doc.text('Alergias:', 5, medY);
    doc.setFont('helvetica', 'normal');
    doc.text((currentPlayer.medicalInfo?.allergies || 'Ninguna conocida').substring(0, 50), 25, medY);
    
    medY += 5;
    // Condiciones mÃ©dicas
    doc.setFont('helvetica', 'bold');
    doc.text('Condiciones:', 5, medY);
    doc.setFont('helvetica', 'normal');
    doc.text((currentPlayer.medicalInfo?.conditions || 'Ninguna').substring(0, 50), 25, medY);
    
    medY += 7;
    // Contacto de emergencia (destacado)
    doc.setFillColor(255, 240, 240);
    doc.roundedRect(3, medY - 3, width - 6, 12, 1, 1, 'F');
    doc.setDrawColor(220, 50, 50);
    doc.setLineWidth(0.3);
    doc.roundedRect(3, medY - 3, width - 6, 12, 1, 1, 'S');
    
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(180, 0, 0);
    doc.text('CONTACTO DE EMERGENCIA:', 5, medY + 1);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(60, 60, 60);
    doc.text(currentPlayer.emergencyContact || currentPlayer.phone || 'No especificado', 5, medY + 6);
    
    medY += 14;
    // DirecciÃ³n
    if (currentPlayer.address) {
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(13, 148, 136);
      doc.text('Direccion:', 5, medY);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(60, 60, 60);
      doc.text(currentPlayer.address.substring(0, 45), 22, medY);
      medY += 5;
    }
    
    // Contacto del club
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(13, 148, 136);
    doc.text('Tel. Club:', 5, medY);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(60, 60, 60);
    doc.text(currentClubSettings?.phone || 'No disponible', 22, medY);
    
    // Footer
    doc.setFontSize(4);
    doc.setTextColor(150, 150, 150);
    doc.text('Este carnet es propiedad de ' + (currentClubSettings?.name || 'la escuela') + '. Si lo encuentra, favor devolverlo.', width / 2, height - 2, { align: 'center' });
    
    // Guardar
    const fileName = 'carnet_' + currentPlayer.name.replace(/\s+/g, '_') + '_' + currentYear + '.pdf';
    doc.save(fileName);
    
    showParentToast('âœ… Carnet descargado');
    
  } catch (error) {
    console.error('Error al generar carnet:', error);
    showParentToast('âŒ Error al generar carnet');
  }
}

function loadScript(src) {
  return new Promise((resolve, reject) => {
    if (document.querySelector('script[src="' + src + '"]')) { resolve(); return; }
    const script = document.createElement('script');
    script.src = src;
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
}

console.log('âœ… Portal de Padres cargado correctamente');

// ========================================
// EDICIÃ“N DE PERFIL DEL JUGADOR
// ========================================

let editAvatarBase64 = null;

function openEditProfileModal() {
  if (!currentPlayer) {
    showParentToast('âŒ No hay datos del jugador');
    return;
  }
  
  document.getElementById('editAvatarPreview').src = currentPlayer.avatar || getDefaultAvatarParent();
  document.getElementById('editName').value = currentPlayer.name || '';
  document.getElementById('editBirthDate').value = currentPlayer.birthDate || '';
  document.getElementById('editJerseyNumber').value = currentPlayer.jerseyNumber || '';
  document.getElementById('editPhone').value = currentPlayer.phone || '';
  document.getElementById('editAddress').value = currentPlayer.address || '';
  document.getElementById('editEmergencyContact').value = currentPlayer.emergencyContact || '';
  document.getElementById('editBloodType').value = currentPlayer.medicalInfo?.bloodType || '';
  document.getElementById('editAllergies').value = currentPlayer.medicalInfo?.allergies || '';
  document.getElementById('editConditions').value = currentPlayer.medicalInfo?.conditions || '';
  
  editAvatarBase64 = null;
  document.getElementById('editProfileModal').classList.remove('hidden');
}

function closeEditProfileModal() {
  document.getElementById('editProfileModal').classList.add('hidden');
  editAvatarBase64 = null;
}

function previewEditAvatar(event) {
  console.log('ğŸ“· DEBUG - previewEditAvatar llamado');
  const file = event.target.files[0];
  console.log('ğŸ“· DEBUG - Archivo:', file);
  
  if (!file) {
    console.log('ğŸ“· DEBUG - No hay archivo');
    return;
  }
  
  console.log('ğŸ“· DEBUG - Tipo:', file.type, 'TamaÃ±o:', file.size);
  
  if (!file.type.startsWith('image/')) {
    showParentToast('âŒ Selecciona una imagen');
    return;
  }
  
  if (file.size > 10 * 1024 * 1024) {
    showParentToast('âŒ Imagen muy grande (mÃ¡x 10MB)');
    return;
  }
  
  showParentToast('â³ Procesando imagen...');
  
  const reader = new FileReader();
  reader.onload = function(e) {
    console.log('ğŸ“· DEBUG - FileReader cargÃ³ la imagen');
    // Comprimir mÃ¡s agresivamente: 300px, 60% calidad
    compressImageParent(e.target.result, 300, 0.6).then(function(compressed) {
      console.log('ğŸ“· DEBUG - Imagen comprimida, longitud:', compressed.length);
      
      // Verificar tamaÃ±o del base64 (Firestore limit ~1MB)
      const sizeInBytes = compressed.length * 0.75; // base64 es ~33% mÃ¡s grande
      const sizeInKB = Math.round(sizeInBytes / 1024);
      
      console.log('ğŸ“· DEBUG - TamaÃ±o final:', sizeInKB, 'KB');
      
      if (sizeInBytes > 900000) { // 900KB para estar seguros
        // Intentar comprimir mÃ¡s
        compressImageParent(e.target.result, 200, 0.5).then(function(moreCompressed) {
          editAvatarBase64 = moreCompressed;
          console.log('ğŸ“· DEBUG - editAvatarBase64 asignado (extra comprimido)');
          document.getElementById('editAvatarPreview').src = moreCompressed;
          showParentToast('âœ… Foto cargada (comprimida)');
        });
      } else {
        editAvatarBase64 = compressed;
        console.log('ğŸ“· DEBUG - editAvatarBase64 asignado:', editAvatarBase64.substring(0, 50) + '...');
        document.getElementById('editAvatarPreview').src = compressed;
        showParentToast('âœ… Foto cargada (' + sizeInKB + 'KB)');
      }
    });
  };
  reader.onerror = function(err) {
    console.error('ğŸ“· DEBUG - Error FileReader:', err);
    showParentToast('âŒ Error al leer la imagen');
  };
  reader.readAsDataURL(file);
}

function compressImageParent(base64, maxWidth, quality) {
  return new Promise(function(resolve) {
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement('canvas');
      let width = img.width;
      let height = img.height;
      
      // Redimensionar si es necesario
      if (width > maxWidth) {
        height = Math.round((height * maxWidth) / width);
        width = maxWidth;
      }
      
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#FFFFFF';
      ctx.fillRect(0, 0, width, height);
      ctx.drawImage(img, 0, 0, width, height);
      
      resolve(canvas.toDataURL('image/jpeg', quality));
    };
    img.onerror = function() { 
      console.error('Error al cargar imagen para comprimir');
      resolve(base64); 
    };
    img.src = base64;
  });
}

document.addEventListener('DOMContentLoaded', function() {
  const editForm = document.getElementById('editProfileForm');
  if (editForm) {
    editForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const saveBtn = document.getElementById('saveProfileBtn');
      const originalText = saveBtn.innerHTML;
      saveBtn.innerHTML = 'â³ Guardando...';
      saveBtn.disabled = true;
      
      try {
        // Debug logs
        console.log('ğŸ” DEBUG - Iniciando guardado...');
        console.log('ğŸ” DEBUG - currentClubId:', currentClubId);
        console.log('ğŸ” DEBUG - currentPlayer.id:', currentPlayer?.id);
        console.log('ğŸ” DEBUG - Firebase disponible:', !!window.firebase?.db);
        console.log('ğŸ” DEBUG - updateDoc disponible:', typeof window.firebase?.updateDoc);
        console.log('ğŸ” DEBUG - editAvatarBase64 tiene valor:', !!editAvatarBase64);
        console.log('ğŸ” DEBUG - editAvatarBase64 longitud:', editAvatarBase64 ? editAvatarBase64.length : 0);
        
        if (!currentClubId || !currentPlayer?.id) {
          throw new Error('Faltan datos: clubId=' + currentClubId + ', playerId=' + currentPlayer?.id);
        }
        
        if (!window.firebase?.db) {
          console.log('ğŸ”„ Reinicializando Firebase...');
          await initFirebaseForParent();
        }
        
        const updatedData = {
          name: document.getElementById('editName').value.trim(),
          birthDate: document.getElementById('editBirthDate').value,
          jerseyNumber: document.getElementById('editJerseyNumber').value,
          phone: document.getElementById('editPhone').value.trim(),
          address: document.getElementById('editAddress').value.trim(),
          emergencyContact: document.getElementById('editEmergencyContact').value.trim(),
          medicalInfo: {
            bloodType: document.getElementById('editBloodType').value,
            allergies: document.getElementById('editAllergies').value.trim(),
            conditions: document.getElementById('editConditions').value.trim()
          },
          updatedAt: new Date().toISOString(),
          updatedBy: 'parent-portal'
        };
        
        // Agregar avatar solo si hay uno nuevo
        if (editAvatarBase64) {
          // Verificar tamaÃ±o antes de enviar
          const avatarSize = editAvatarBase64.length * 0.75;
          console.log('ğŸ“¸ DEBUG - TamaÃ±o de avatar:', Math.round(avatarSize / 1024), 'KB');
          
          if (avatarSize > 900000) {
            showParentToast('âŒ Imagen muy grande, intenta con otra');
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
            return;
          }
          updatedData.avatar = editAvatarBase64;
        }
        
        console.log('ğŸ“¤ DEBUG - Campos a guardar:', Object.keys(updatedData));
        console.log('ğŸ“¤ DEBUG - Ruta:', 'clubs/' + currentClubId + '/players/' + currentPlayer.id);
        
        const playerRef = window.firebase.doc(window.firebase.db, 'clubs/' + currentClubId + '/players', currentPlayer.id);
        
        console.log('ğŸ“¤ DEBUG - Llamando updateDoc...');
        await window.firebase.updateDoc(playerRef, updatedData);
        
        console.log('âœ… DEBUG - Guardado exitoso!');
        
        // Actualizar datos locales
        currentPlayer = Object.assign({}, currentPlayer, updatedData);
        
        showParentToast('âœ… Perfil actualizado');
        closeEditProfileModal();
        showPlayerProfile();
        
      } catch (error) {
        console.error('âŒ DEBUG - Error completo:', error);
        console.error('âŒ DEBUG - Error code:', error.code);
        console.error('âŒ DEBUG - Error message:', error.message);
        
        // Mostrar mensaje de error especÃ­fico
        let errorMsg = 'Error al guardar';
        if (error.code === 'permission-denied') {
          errorMsg = 'Sin permiso - Verifica Security Rules';
        } else if (error.code === 'unavailable') {
          errorMsg = 'Sin conexiÃ³n a internet';
        } else if (error.code === 'not-found') {
          errorMsg = 'Jugador no encontrado';
        } else if (error.message && error.message.includes('bytes')) {
          errorMsg = 'Imagen muy grande';
        } else if (error.message) {
          errorMsg = error.message.substring(0, 50);
        }
        
        showParentToast('âŒ ' + errorMsg);
      } finally {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
      }
    });
  }
});

// ========================================
// DESCARGAR RECIBO DE PAGO PDF
// ========================================

async function downloadPaymentReceipt(paymentIndex) {
  const payments = currentPlayer.payments || [];
  const sortedPayments = payments.sort(function(a, b) {
    return new Date(b.dueDate || b.createdAt) - new Date(a.dueDate || a.createdAt);
  });
  const payment = sortedPayments[paymentIndex];
  
  if (!payment) {
    showParentToast('âŒ Pago no encontrado');
    return;
  }
  
  showParentToast('â³ Generando recibo...');
  
  try {
    if (typeof window.jspdf === 'undefined') {
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
    }
    
    const jsPDF = window.jspdf.jsPDF;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a5' });
    
    const width = 148;
    const height = 210;
    const margin = 10;
    const receiptNumber = 'REC-' + (payment.id || Date.now()).toString().substring(0, 8).toUpperCase();
    const receiptDate = new Date().toLocaleDateString('es-CO');
    
    // Header
    doc.setFillColor(13, 148, 136);
    doc.rect(0, 0, width, 30, 'F');
    
    if (currentClubSettings?.logo && currentClubSettings.logo.startsWith('data:image')) {
      try { doc.addImage(currentClubSettings.logo, 'PNG', margin, 5, 18, 18); } catch(e) {}
    }
    
    doc.setFontSize(12);
    doc.setTextColor(255, 255, 255);
    doc.setFont('helvetica', 'bold');
    doc.text((currentClubSettings?.name || 'Escuela de FÃºtbol').substring(0, 30), margin + 22, 12);
    
    doc.setFontSize(8);
    doc.setFont('helvetica', 'normal');
    doc.text('RECIBO DE PAGO', margin + 22, 20);
    doc.text('No. ' + receiptNumber, margin + 22, 26);
    
    // Fecha
    doc.setFontSize(8);
    doc.setTextColor(100, 100, 100);
    doc.text('Fecha: ' + receiptDate, width - margin, 40, { align: 'right' });
    
    // Datos del estudiante
    let y = 50;
    doc.setFillColor(245, 245, 245);
    doc.roundedRect(margin, y, width - margin * 2, 25, 2, 2, 'F');
    
    doc.setFontSize(9);
    doc.setTextColor(13, 148, 136);
    doc.setFont('helvetica', 'bold');
    doc.text('ESTUDIANTE', margin + 5, y + 7);
    
    doc.setTextColor(50, 50, 50);
    doc.setFont('helvetica', 'normal');
    doc.text('Nombre: ' + (currentPlayer.name || '-'), margin + 5, y + 14);
    doc.text('CategorÃ­a: ' + (currentPlayer.category || '-'), margin + 5, y + 20);
    
    // Detalle del pago
    y = 85;
    doc.setFillColor(13, 148, 136);
    doc.rect(margin, y, width - margin * 2, 8, 'F');
    doc.setFontSize(9);
    doc.setTextColor(255, 255, 255);
    doc.setFont('helvetica', 'bold');
    doc.text('DETALLE DEL PAGO', margin + 5, y + 5.5);
    
    y += 12;
    doc.setDrawColor(200, 200, 200);
    doc.setLineWidth(0.3);
    doc.rect(margin, y, width - margin * 2, 20, 'S');
    
    doc.setTextColor(50, 50, 50);
    doc.setFont('helvetica', 'normal');
    doc.text('Concepto: ' + (payment.concept || payment.type || 'Pago'), margin + 5, y + 7);
    doc.text('Fecha: ' + formatDateParent(payment.paidDate || payment.dueDate), margin + 5, y + 14);
    
    doc.setFont('helvetica', 'bold');
    doc.text('Total: ' + formatCurrencyParent(payment.amount), width - margin - 5, y + 14, { align: 'right' });
    
    // Estado pagado
    y += 30;
    doc.setFillColor(34, 197, 94);
    doc.roundedRect(margin + 30, y, width - margin * 2 - 60, 12, 2, 2, 'F');
    doc.setFontSize(11);
    doc.setTextColor(255, 255, 255);
    doc.text('PAGADO', width / 2, y + 8, { align: 'center' });
    
    // Footer
    doc.setFontSize(7);
    doc.setTextColor(120, 120, 120);
    doc.text('Comprobante generado desde Portal de Padres', width / 2, height - 15, { align: 'center' });
    doc.text(currentClubSettings?.name || 'Escuela de FÃºtbol', width / 2, height - 10, { align: 'center' });
    
    const fileName = 'recibo_' + currentPlayer.name.replace(/\s+/g, '_') + '_' + receiptNumber + '.pdf';
    doc.save(fileName);
    
    showParentToast('âœ… Recibo descargado');
    
  } catch (error) {
    console.error('Error al generar recibo:', error);
    showParentToast('âŒ Error al generar recibo');
  }
}
    </script>
</body>
</html>